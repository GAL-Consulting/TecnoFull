<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Catálogo TecnoFull DC</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <style>
    /* pequeño ajuste visual para el dropdown */
    .submenu-desktop { min-width: 14rem; max-height: 60vh; overflow:auto; }
  </style>
</head>
<body class="bg-white text-gray-900 font-sans">

 <!-- NAVBAR -->
  <nav class="bg-black p-4 flex justify-between items-center">
   

    <!-- Botón hamburguesa (solo móvil) -->
    <button id="menuBtn" class="sm:hidden text-white focus:outline-none">
      ☰
    </button>

    <!-- Menú escritorio -->
  <div class="bg-red-700 text-white p-1 text-center"></div>
  <div class="max-w-6xl mx-auto px-4 flex justify-between items-center py-3">
    <div class="flex-shrink-0 mr-6">
      <a href="#" class="text-white text-lg font-bold">TecnoFull DC</a>
    </div>

    <div class="flex items-center space-x-4">
      <!-- Dropdown Productos (botón) -->
      <div class="relative">
        <button id="btnMarcas" class="hover:bg-gray-800 px-3 py-2 rounded bg-black border border-gray-700">
          Marcas ▾
        </button>
        <div id="menuMarcas" class="submenu-desktop absolute left-0 mt-2 bg-black text-white rounded shadow-lg hidden">
          <!-- se llenará dinámicamente -->
        </div>
      </div>

      <input id="searchInput" type="text" placeholder="Buscar productos..."
             class="w-48 md:w-64 p-2 rounded border text-black" />
    </div>
  </div>
  <div class="bg-red-700 text-white p-1 text-center"></div>
  </nav>

  <!-- Menú móvil -->
  <div id="mobileMenu" class="hidden bg-black sm:hidden">
    <div id="marcaMenuMobile" class="flex flex-col"></div>
  </div>





<main id="catalogo" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 p-6"></main>
/*

<!--  

<main id="catalogo" class="max-w-7xl mx-auto p-6 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 pt-24"></main>
class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 p-6"-->

<script>
/* ===================== CONFIG ===================== */
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRkMjpmwhaQZ3ZIbdHQt8bxM9oM2KmlzaEKeMi-N7Ct8GyzClX68YiP03F_myzpfi86BtPgqw9neTgb/pub?gid=541804413&single=true&output=csv";

/* ===================== HELPERS ===================== */
function parseNumber(s){
  if (s === null || s === undefined) return 0;
  if (typeof s === 'number') return s;
  let t = String(s).trim();
  t = t.replace(/\s/g, '').replace(/\./g,'').replace(/,/g,'.'); // "1.234,56" -> "1234.56"
  const n = parseFloat(t);
  return isNaN(n) ? 0 : n;
}
function cleanUrl(raw){
  if (!raw && raw !== 0) return "";
  let s = String(raw).trim();
  s = s.replace(/^href\s*=\s*/i, '');
  s = s.replace(/[“”]/g, '"');
  s = s.replace(/^"+|"+$/g, '');
  return s.trim();
}
function capitalizeDisplay(text){
  if (!text) return "";
  text = String(text).trim();
  return text.charAt(0).toUpperCase() + text.slice(1).toLowerCase();
}

/* Normaliza y extrae los campos que usamos (tolerante con nombres de columna) */
function normalizeRow(rawRow){
  // rawRow: objeto { "MODELO": "XVR...", "MARCA": "DAHUA", ... } pero keys pueden variar.
  const map = {};
  Object.keys(rawRow).forEach(k => {
    map[k.trim().toLowerCase()] = rawRow[k];
  });

  const modelo = map['modelo'] || map['producto'] || map['product'] || map['model'] || "";
  const marca = map['marca'] || map['brand'] || "";
  const tipo  = map['tipo'] || map['tipo_producto'] || map['category'] || map['tipo producto'] || "";
  const descripcion = map['descripcion'] || map['description'] || map['descr'] || "";
  const precioUsdRaw = map['precio_usd'] || map['precio usd'] || map['usd'] || map['precio'] || "";
  const precioArsRaw = map['precio_ars'] || map['precio ars'] || map['ars'] || "";
  const fichaRaw = map['ficha_link'] || map['ficha link'] || map['ficha'] || map['url_ficha'] || map['url ficha'] || "";
  const imagenRaw = map['imagen_link'] || map['imagen link'] || map['imagen'] || map['url_imagen'] || map['url imagen'] || map['image'] || "";

  return {
    PRODUCTO: String(modelo || "").trim(),
    MARCA: String(marca || "").trim(),
    TIPO_PRODUCTO: String(tipo || "").trim(),
    DESCRIPCION: String(descripcion || "").trim(),
    PRECIO_USD: parseNumber(precioUsdRaw),
    PRECIO_ARS: parseNumber(precioArsRaw),
    URL_FICHA: cleanUrl(fichaRaw),
    URL_IMAGEN: cleanUrl(imagenRaw)
  };
}

/* ===================== UI & LÓGICA ===================== */
const catalogo = document.getElementById("catalogo");
const searchInput = document.getElementById("searchInput");
const menuMarcas = document.getElementById("menuMarcas");
const btnMarcas = document.getElementById("btnMarcas");

let productosData = [];      // array completo de productos (objetos normalizados)
let marcaSeleccionada = null; // string en minúsculas

const formatUSD = new Intl.NumberFormat("en-US", { style: "currency", currency: "USD" });
const formatARS = new Intl.NumberFormat("es-AR", { style: "currency", currency: "ARS" });

function renderProductos(lista){
  catalogo.innerHTML = "";
  if (!lista || lista.length === 0) {
    catalogo.innerHTML = "<p class='col-span-full text-center text-gray-500'>No se encontraron productos.</p>";
    return;
  }
  lista.forEach(p => {
    const card = document.createElement("div");
    card.className = "producto bg-white rounded-2xl shadow-md p-4 flex flex-col";
    card.innerHTML = `
      <img src="${p.URL_IMAGEN || 'https://via.placeholder.com/300x180?text=No+image'}" alt="${escapeHtml(p.PRODUCTO)}" class="rounded-lg mb-3 mx-auto">
      <h2 class="text-lg font-bold text-red-800">${escapeHtml(p.PRODUCTO)}</h2>
      <p class="text-sm text-gray-800 font-medium">${escapeHtml(p.TIPO_PRODUCTO)}</p>
      <span class="my-2 text-xs font-semibold bg-gray-200 text-gray-800 px-2 py-1 rounded self-start">
        ${escapeHtml(p.MARCA)}
      </span>
      <p class="text-gray-600 text-sm flex-grow">${escapeHtml(p.DESCRIPCION)}</p>
      <p class="text-green-700 font-semibold mt-2">${formatUSD.format(p.PRECIO_USD)}</p>
      <p class="text-blue-700 font-semibold">${formatARS.format(p.PRECIO_ARS)}</p>
      <a href="${p.URL_FICHA || '#'}" target="_blank" class="mt-3 inline-block text-center bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition">
        Ver Ficha Técnica
      </a>
    `;
    catalogo.appendChild(card);
  });
}

function escapeHtml(text){
  if (text === null || text === undefined) return "";
  return String(text)
    .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
    .replaceAll('"','&quot;').replaceAll("'",'&#39;');
}

function aplicarFiltros(){
  const texto = (searchInput.value || "").trim().toLowerCase();
  let lista = productosData;

  if (marcaSeleccionada) {
    lista = lista.filter(p => (p.MARCA || "").toLowerCase() === marcaSeleccionada);
  }
  if (texto) {
    lista = lista.filter(p =>
      (p.PRODUCTO && p.PRODUCTO.toLowerCase().includes(texto)) ||
      (p.MARCA && p.MARCA.toLowerCase().includes(texto)) ||
      (p.TIPO_PRODUCTO && p.TIPO_PRODUCTO.toLowerCase().includes(texto)) ||
      (p.DESCRIPCION && p.DESCRIPCION.toLowerCase().includes(texto))
    );
  }
  renderProductos(lista);
}

/* Construye menú dinámico de marcas */
function construirMenuMarcas(){
  menuMarcas.innerHTML = "";
  const marcas = [...new Set(productosData.map(p => (p.MARCA || "").trim().toLowerCase()).filter(Boolean))].sort();
  // opción Todas
  const optTodas = document.createElement("a");
  optTodas.href = "#";
  optTodas.textContent = "Todas las marcas";
  optTodas.className = "block px-4 py-2 hover:bg-gray-800";
  optTodas.addEventListener("click", e => {
    e.preventDefault();
    marcaSeleccionada = null;
    aplicarFiltros();
    cerrarMenuMarcas();
  });
  menuMarcas.appendChild(optTodas);
  menuMarcas.appendChild(document.createElement("hr"));
  marcas.forEach(m => {
    const a = document.createElement("a");
    a.href = "#";
    a.textContent = capitalizeDisplay(m);
    a.dataset.marca = m;
    a.className = "block px-4 py-2 hover:bg-gray-800";
    a.addEventListener("click", e => {
      e.preventDefault();
      marcaSeleccionada = e.currentTarget.dataset.marca;
      aplicarFiltros();
      cerrarMenuMarcas();
    });
    menuMarcas.appendChild(a);
  });

  // debug
  console.log("Marcas únicas encontradas:", marcas.length, marcas);
}

/* controls para dropdown (toggle) */
function toggleMenuMarcas(){
  menuMarcas.classList.toggle("hidden");
}
function cerrarMenuMarcas(){
  if (!menuMarcas.classList.contains("hidden")) menuMarcas.classList.add("hidden");
}

btnMarcas.addEventListener("click", (e) => {
  e.stopPropagation();
  toggleMenuMarcas();
});

// cerrar al click fuera
document.addEventListener("click", (e) => {
  if (!menuMarcas.contains(e.target) && e.target !== btnMarcas) cerrarMenuMarcas();
});

// buscador
searchInput.addEventListener("input", aplicarFiltros);

/* ===================== CARGA CSV (PapaParse) ===================== */
function cargarCSVConPapa(){
  Papa.parse(CSV_URL, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
      console.log("CSV descargado. Filas crudas:", results.data.length);
      // Normalizar filas y filtrar vacías
      const filasNorm = results.data.map(normalizeRow).filter(r => r.PRODUCTO || r.MARCA || r.DESCRIPCION);
      productosData = filasNorm;
      console.log("Productos válidos tras normalización:", productosData.length);
      construirMenuMarcas();
      aplicarFiltros();
    },
    error: function(err) {
      console.error("Error al descargar/parsear CSV:", err);
      catalogo.innerHTML = "<p class='col-span-full text-center text-red-600'>Error al cargar catálogo. Ver consola para más detalles.</p>";
    }
  });
}

/* Ejecutar carga */
cargarCSVConPapa();
</script>

</body>
</html>
