<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Catálogo TecnoFull DC</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- PapaParse para leer CSV remoto -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <style>.hidden{display:none}</style>
</head>
<body class="bg-white text-gray-900 font-sans">
<nav class="bg-black text-white fixed top-0 w-full z-50 shadow-md">
  <div class="bg-red-700 text-white p-1 text-center"></div>
  <div class="max-w-6xl mx-auto px-4 flex justify-between items-center py-3">
    <div class="flex-shrink-0 mr-6">
      <a href="#" class="text-white text-lg font-bold">TecnoFull DC</a>
    </div>
    <div class="hidden md:flex space-x-6 items-center">
      <a href="#" class="hover:bg-black px-3 py-2 rounded">Inicio</a>
      <a href="#" class="hover:bg-black px-3 py-2 rounded">Quiénes Somos</a>
      <a href="#" class="hover:bg-black px-3 py-2 rounded">Contacto</a>
    </div>
    <input id="searchInput" type="text" placeholder="Buscar productos..." class="w-48 md:w-64 p-2 rounded border text-black">
  </div>
  <div class="bg-red-700 text-white p-1 text-center"></div>
</nav>

<main id="catalogo" class="max-w-7xl mx-auto p-6 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 pt-24"></main>

<script>
/*
  CONFIG: reemplazá por tu URL publicada (CSV).
  Ejemplo tuya (la que compartiste):
*/
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRkMjpmwhaQZ3ZIbdHQt8bxM9oM2KmlzaEKeMi-N7Ct8GyzClX68YiP03F_myzpfi86BtPgqw9neTgb/pub?gid=541804413&single=true&output=csv";

const catalogo = document.getElementById("catalogo");
const searchInput = document.getElementById("searchInput");
let productosData = [];

// Formateadores de moneda
const formatUSD = new Intl.NumberFormat("en-US", { style: "currency", currency: "USD" });
const formatARS = new Intl.NumberFormat("es-AR", { style: "currency", currency: "ARS" });

function renderProductos(lista) {
  catalogo.innerHTML = "";
  lista.forEach(p => {
    const card = document.createElement("div");
    card.className = "producto bg-white rounded-2xl shadow-md p-4 flex flex-col";
    card.innerHTML = `
      <img src="${p.URL_IMAGEN || 'https://via.placeholder.com/200x120?text=No+image'}" alt="${escapeHtml(p.PRODUCTO)}" class="rounded-lg mb-3 mx-auto">
      <h2 class="text-lg font-bold text-red-800">${escapeHtml(p.PRODUCTO)}</h2>
      <p class="text-lg font-bold text-gray-800">${escapeHtml(p.TIPO_PRODUCTO)}</p>
      <span class="my-2 text-xs font-semibold bg-gray-200 text-gray-800 px-2 py-1 rounded self-start">
        ${escapeHtml(p.MARCA)}
      </span>
      <p class="text-gray-600 text-sm flex-grow">${escapeHtml(p.DESCRIPCION)}</p>
      <p class="text-green-700 font-semibold mt-2">${formatUSD.format(p.PRECIO_USD)}</p>
      <p class="text-blue-700 font-semibold">${formatARS.format(p.PRECIO_ARS)}</p>
      <a href="${p.URL_FICHA || '#'}" target="_blank" class="mt-3 inline-block text-center bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition">
        Ver Ficha Técnica
      </a>
    `;
    catalogo.appendChild(card);
  });
}

// búsqueda
function buscarProductos() {
  const texto = searchInput.value.trim().toLowerCase();
  if (!texto) return renderProductos(productosData);
  const filtrados = productosData.filter(p =>
    (p.PRODUCTO && p.PRODUCTO.toLowerCase().includes(texto)) ||
    (p.MARCA && p.MARCA.toLowerCase().includes(texto)) ||
    (p.TIPO_PRODUCTO && p.TIPO_PRODUCTO.toLowerCase().includes(texto)) ||
    (p.DESCRIPCION && p.DESCRIPCION.toLowerCase().includes(texto))
  );
  renderProductos(filtrados);
}
searchInput.addEventListener("input", buscarProductos);

// Helpers
function parseNumber(s){
  if (s === null || s === undefined) return 0;
  if (typeof s === 'number') return s;
  let t = s.toString().trim();
  // eliminar espacios, puntos de miles y convertir coma decimal a punto
  t = t.replace(/\s/g,'').replace(/\./g,'').replace(/,/g,'.');
  const n = parseFloat(t);
  return isNaN(n) ? 0 : n;
}
function cleanUrl(raw){
  if(!raw) return "";
  let s = raw.toString().trim();
  // quitar prefijos tipo href= y comillas curvas
  s = s.replace(/^href\s*=\s*/i, '');
  s = s.replace(/[“”]/g, '"');
  s = s.replace(/^"+|"+$/g, '');
  s = s.trim();
  return s;
}
function escapeHtml(text){
  if (!text && text !== 0) return "";
  return String(text)
    .replaceAll('&', '&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'", '&#39;');
}

// Mapeo flexible: busca keys en minúscula sin acentos exactos
function getFieldFromRow(row, candidates){
  const mapLower = {};
  Object.keys(row).forEach(k => { mapLower[k.trim().toLowerCase()] = row[k]; });
  for (const c of candidates){
    const v = mapLower[c.toLowerCase()];
    if (v !== undefined && v !== "") return v;
  }
  return "";
}

// Cargar CSV usando PapaParse
function cargarDesdeCSV() {
  Papa.parse(CSV_URL, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
      console.log("CSV parse complete, filas:", results.data.length);
      productosData = results.data.map(row => {
        // candidatos comunes para cada campo (insensible a mayúsculas)
        const modelo = getFieldFromRow(row, ['modelo','producto','product','MODEL']);
        const marca = getFieldFromRow(row, ['marca','brand']);
        const tipo = getFieldFromRow(row, ['tipo','tipo_producto','tipo producto','category']);
        const descripcion = getFieldFromRow(row, ['descripcion','description','descr']);
        const precioUsdRaw = getFieldFromRow(row, ['precio_usd','precio usd','usd','precio']);
        const precioArsRaw = getFieldFromRow(row, ['precio_ars','precio ars','ars']);
        const fichaRaw = getFieldFromRow(row, ['ficha_link','ficha','ficha link','url_ficha','url ficha']);
        const imagenRaw = getFieldFromRow(row, ['imagen_link','imagen','imagen link','url_imagen','url imagen','image']);
        return {
          PRODUCTO: modelo || "",
          MARCA: marca || "",
          TIPO_PRODUCTO: tipo || "",
          DESCRIPCION: descripcion || "",
          PRECIO_USD: parseNumber(precioUsdRaw),
          PRECIO_ARS: parseNumber(precioArsRaw),
          URL_FICHA: cleanUrl(fichaRaw),
          URL_IMAGEN: cleanUrl(imagenRaw)
        };
      });
      renderProductos(productosData);
    },
    error: function(err){
      console.error("Error al bajar/parsear CSV:", err);
      // si hay error, mostrar aviso simple en la página
      catalogo.innerHTML = "<p class='text-red-600'>No pude cargar el CSV. Revisa que la hoja esté publicada y que la URL sea accesible.</p>";
    }
  });
}

// Ejecutar carga
cargarDesdeCSV();

</script>
</body>
</html>
